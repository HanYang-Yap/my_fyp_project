<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniTopia AI 升學輔助系統 - 個人資料</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            color: #3a4049;
            display: flex;
            min-height: 100vh;
        }
        
        /* 側邊欄樣式 */
        .sidebar {
            width: 260px;
            background: linear-gradient(135deg, #383d49 0%, #272a33 100%);
            color: #e8eaed;
            padding: 20px 0;
            min-height: 100vh;
            box-shadow: 5px 0 10px rgba(0, 0, 0, 0.1);
            position: fixed;
            z-index: 10;
        }
        
        .logo-container {
            padding: 10px 20px;
            margin: 10px 25px 30px;
            background-color: rgba(58, 63, 75, 0.5);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo {
            font-size: 24px;
            font-weight: bold;
        }
        
        .logo-icon {
            color: #8aa2aa;
            font-size: 20px;
        }
        
        .menu-item {
            padding: 15px 25px;
            margin: 5px 25px;
            display: flex;
            align-items: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item:hover:not(.active) {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .menu-item i {
            width: 24px;
            margin-right: 15px;
            color: #9da3b4;
        }
        
        .menu-item.active i, .menu-item.active span {
            color: #e8eaed;
        }
        
        .menu-item span {
            color: #9da3b4;
        }
        
        .menu-item.active span {
            font-weight: bold;
        }
        
        .logout {
            margin-top: auto;
            position: absolute;
            bottom: 30px;
            width: 210px;
        }
        
        /* 主要內容區域 */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            background-color: #f0f2f5;
        }
        
        .content-container {
            background-color: #ffffff;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            min-height: calc(100vh - 60px);
        }
        
        /* 個人資料卡片 */
        .profile-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .profile-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
            flex: 1;
            min-width: 350px;
        }
        
        .card-title {
            font-size: 18px;
            color: #3a4049;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eaecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .edit-mode-toggle {
            background-color: #f5f7fa;
            border: 1px solid #e1e4e8;
            color: #3a4049;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .edit-mode-toggle:hover {
            background-color: #eaecef;
        }
        
        .edit-mode-toggle.active {
            background-color: #5d8a9e;
            color: white;
            border-color: #5d8a9e;
        }
        
        /* 表單樣式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            color: #636973;
            margin-bottom: 5px;
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            background-color: #f5f7fa;
            color: #3a4049;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .form-control:disabled {
            background-color: #f5f7fa;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .form-control:focus {
            border-color: #5d8a9e;
            outline: none;
            box-shadow: 0 0 0 2px rgba(93, 138, 158, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .btn {
            background-color: #5d8a9e;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background-color: #4d7a8e;
        }
        
        .btn:disabled {
            background-color: #c5d7e0;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #e1e4e8;
            color: #3a4049;
        }
        
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        
        .btn-block {
            display: block;
            width: 100%;
        }
        
        /* 志願序列表 */
        .preference-list {
            list-style: none;
            margin-top: 15px;
        }
        
        /* Add these CSS styles for drag-and-drop functionality */
        .preference-item {
            cursor: grab;
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background-color: #f5f7fa;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
            transition: all 0.2s;
        }

        .preference-item.dragging {
            opacity: 0.6;
            background-color: #f0f7fa;
            cursor: grabbing;
        }

        .preference-item.drag-over {
            border: 2px dashed #5d8a9e;
        }

        .drag-handle {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            color: #9da3b4;
            cursor: grab;
        }

        .drag-handle i {
            font-size: 16px;
        }
        
        .preference-item:hover {
            background-color: #edf1f7;
        }
        
        .preference-rank {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background-color: #5d8a9e;
            color: white;
            font-weight: bold;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .preference-item:nth-child(1) .preference-rank {
            background-color: #e25c5c; /* 第1志願用紅色 */
        }
        
        .preference-item:nth-child(2) .preference-rank {
            background-color: #f1ae4e; /* 第2志願用橙色 */
        }
        
        .preference-item:nth-child(3) .preference-rank {
            background-color: #5d8a9e; /* 第3志願用藍色 */
        }
        
        .preference-item:nth-child(4) .preference-rank {
            background-color: #6a8caf; /* 第4志願用淡藍色 */
        }
        
        .preference-item:nth-child(5) .preference-rank {
            background-color: #7d9e6a; /* 第5志願用綠色 */
        }
        
        .preference-item:nth-child(6) .preference-rank {
            background-color: #9e7d6a; /* 第6志願用棕色 */
        }
        
        .preference-content {
            flex: 1;
        }
        
        .preference-school {
            font-weight: bold;
            color: #3a4049;
            margin-bottom: 3px;
        }
        
        .preference-department {
            font-size: 14px;
            color: #636973;
        }
        
        .preference-actions {
            display: flex;
            gap: 10px;
        }
        
        .preference-action-btn {
            background: none;
            border: none;
            color: #9da3b4;
            cursor: pointer;
            font-size: 16px;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .preference-action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .preference-action-btn.edit:hover {
            color: #5d8a9e;
        }
        
        .preference-action-btn.delete:hover {
            color: #e25c5c;
        }
        
        .add-preference-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: #f5f7fa;
            border: 1px dashed #d1d5db;
            color: #636973;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            margin-top: 15px;
        }
        
        .add-preference-btn:hover {
            background-color: #edf1f7;
            color: #3a4049;
        }
        
        /* 模態框樣式 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }
        
        .modal-content {
            background-color: #fff;
            border-radius: 12px;
            padding: 0;
            width: 500px;
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
            animation: modalFadeIn 0.2s ease-out;
        }
        
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            background-color: #3a5a6a;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
            max-height: calc(90vh - 130px);
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #eaecef;
        }
        
        /* 通知與訊息 */
        .notification {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #3a4049;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Add to your existing CSS */
        .profile-header {
            background: linear-gradient(135deg, #547a8c 0%, #3a5a6a 100%);
            color: white;
            padding: 30px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            border-radius: 20px 20px 0 0;
            margin-bottom: 20px;
        }

        .profile-picture {
            width: 120px;
            height: 120px;
            background-color: #e8eaed;
            border-radius: 60px;
            margin-right: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: #3a5a6a;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            min-width: 200px;
        }

        .profile-info h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .profile-info p {
            margin-bottom: 5px;
            opacity: 0.9;
        }
        
        .notification.success {
            background-color: #e6f3ea;
            border-left: 4px solid #5cb85c;
        }
        
        .notification.warning {
            background-color: #fff8e6;
            border-left: 4px solid #f1ae4e;
        }
        
        .notification.error {
            background-color: #fce8e8;
            border-left: 4px solid #e25c5c;
        }
        
        .notification.info {
            background-color: #e6f1f8;
            border-left: 4px solid #5d8a9e;
        }
        
        /* 加載狀態 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            color: #636973;
        }
        
        .loading-spinner {
            border: 3px solid #f5f7fa;
            border-top: 3px solid #5d8a9e;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        /* Replace the existing preference rank color styles with this */
        .preference-item:nth-child(1) .preference-rank {
            background-color: #4e54c8; /* 第1志願用深藍紫色 */
        }

        .preference-item:nth-child(2) .preference-rank {
            background-color: #5d8a9e; /* 第2志願用藍綠色 */
        }

        .preference-item:nth-child(3) .preference-rank {
            background-color: #3cb371; /* 第3志願用綠色 */
        }

        .preference-item:nth-child(4) .preference-rank {
            background-color: #f9a825; /* 第4志願用黃色 */
        }

        .preference-item:nth-child(5) .preference-rank {
            background-color: #e57373; /* 第5志願用淡紅色 */
        }

        .preference-item:nth-child(6) .preference-rank {
            background-color: #9575cd; /* 第6志願用紫色 */
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .logo-container {
                justify-content: center;
                margin: 10px auto 30px;
                padding: 10px;
                width: 50px;
            }
            
            .logo {
                display: none;
            }
            
            .menu-item span {
                display: none;
            }
            
            .menu-item {
                justify-content: center;
                padding: 15px 0;
                margin: 5px auto;
                width: 50px;
            }
            
            .menu-item i {
                margin-right: 0;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .logout {
                width: 50px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .form-row .form-group {
                margin-bottom: 0;
            }
        }
    </style>
    <!-- Font Awesome CDN for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <!-- 側邊欄 -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">UniTopia</div>
            <div class="logo-icon">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div class="menu-item" onclick="window.location.href='/home/{{ student_id }}'">
            <i class="fas fa-home"></i>
            <span>首頁</span>
        </div>
        
        <div class="menu-item active" onclick="window.location.href='/profile/{{ student_id }}'">
            <i class="fas fa-user"></i>
            <span>個人資料</span>
        </div>

        <div class="menu-item" onclick="window.location.href='/file_upload&management/{{ student_id }}'">
            <i class="fas fa-file-alt"></i>
            <span>學習歷程</span>
        </div>
        
        <div class="menu-item" onclick="window.location.href='/calendar/{{ student_id }}'">
            <i class="fas fa-calendar"></i>
            <span>日程表</span>
        </div>
        
        <div class="menu-item" onclick="window.location.href='/faq/{{ student_id }}'">
            <i class="fas fa-question-circle"></i>
            <span>常見問題</span>
        </div>
        
        <div class="menu-item logout" id="logout-btn">
            <i class="fas fa-sign-out-alt"></i>
            <span>登出</span>
        </div>
    </div>
    
    <!-- 主要內容區域 -->
    <div class="main-content">
        <div class="content-container">
            <div class="page-header">
                <!-- <h1 class="page-title" id="student-name">載入中...</h1> -->
            </div>

            <div class="profile-header">
                <div class="profile-picture" id="profile-picture"></div>
                <div class="profile-info">
                    <h1 id="header-name">載入中...</h1>
                    <p id="header-school-info">載入中...</p>
                    <p id="header-grade-info">載入中...</p>
                    <p id="header-class-info">載入中...</p>
                    <p id="header-target-departments">目標科系：載入中...</p>
                </div>
            </div>
            
            <div id="notification-area"></div>
            
            <div class="profile-section">
                <div class="profile-card">
                    <div class="card-title">
                        <span>個人基本資料</span>
                        <button class="edit-mode-toggle" id="toggle-personal-edit">
                            <i class="fas fa-pen"></i> 編輯
                        </button>
                    </div>
                    
                    <form id="personal-info-form">
                        <div class="form-group">
                            <label class="form-label" for="profile-name">姓名</label>
                            <input type="text" class="form-control" id="profile-name" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="profile-school">就讀學校</label>
                            <input type="text" class="form-control" id="profile-school" disabled>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="profile-grade">年級</label>
                                <input type="text" class="form-control" id="profile-grade" disabled>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="profile-class">班級</label>
                                <input type="text" class="form-control" id="profile-class" disabled>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="profile-email">電子郵件</label>
                            <input type="email" class="form-control" id="profile-email" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="profile-phone">聯絡電話</label>
                            <input type="tel" class="form-control" id="profile-phone" disabled>
                        </div>
                        
                        <button type="submit" class="btn btn-block" id="save-personal-info" disabled>更新基本資料</button>
                    </form>
                </div>
                
                <div class="profile-card">
                    <div class="card-title">
                        <span>志願序 (最多6個)</span>
                    </div>
                    
                    <div id="preferences-container">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <span>載入中...</span>
                        </div>
                    </div>
                    
                    <button class="add-preference-btn" id="add-preference-btn">
                        <i class="fas fa-plus"></i> 新增志願
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 新增/編輯志願模態框 -->
    <div class="modal-overlay" id="preference-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="preference-modal-title">新增志願</h3>
                <button class="modal-close" id="preference-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="preference-form">
                    <input type="hidden" id="preference-edit-index" value="-1">
                    
                    <div class="form-group">
                        <label class="form-label" for="preference-rank">志願序</label>
                        <select class="form-control" id="preference-rank" required>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                            <option value="6">6</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="preference-school">學校</label>
                        <input type="text" class="form-control" id="preference-school" required placeholder="例如：國立臺灣大學">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="preference-department">科系</label>
                        <input type="text" class="form-control" id="preference-department" required placeholder="例如：資訊工程學系">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="preference-modal-cancel">取消</button>
                <button class="btn" id="preference-modal-save">儲存</button>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        // 初始化 Firebase (在實際使用時，這些值會由 Flask 傳入)
// Initialize Firebase (with config from Flask)

        // Initialize Firebase (check if configuration is valid)
        // Global variables first
        const STUDENT_ID = "{{ student_id }}" || "test_student_id";
        let db;
        let studentData = {};
        let preferredDepartments = [];

        // Then Firebase initialization
        const firebaseConfig = {
            apiKey: "{{ firebase_config.apiKey if firebase_config is defined else '' }}",
            authDomain: "{{ firebase_config.authDomain if firebase_config is defined else '' }}",
            projectId: "{{ firebase_config.projectId if firebase_config is defined else '' }}",
            storageBucket: "{{ firebase_config.storageBucket if firebase_config is defined else '' }}",
            messagingSenderId: "{{ firebase_config.messagingSenderId if firebase_config is defined else '' }}",
            appId: "{{ firebase_config.appId if firebase_config is defined else '' }}"
        };

        // Initialize Firebase only after document is ready
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                
                // Now load data after initialization
                loadStudentData();
                loadPreferredDepartments();
                
                // Set up event listeners
                setupEventListeners();
            }
        });
        
        // DOM 元素
        const personalInfoForm = document.getElementById('personal-info-form');
        const togglePersonalEditBtn = document.getElementById('toggle-personal-edit');
        const savePersonalInfoBtn = document.getElementById('save-personal-info');
        const preferencesContainer = document.getElementById('preferences-container');
        const addPreferenceBtn = document.getElementById('add-preference-btn');
        const preferenceModal = document.getElementById('preference-modal');
        const preferenceModalTitle = document.getElementById('preference-modal-title');
        const preferenceForm = document.getElementById('preference-form');
        const preferenceEditIndex = document.getElementById('preference-edit-index');
        const preferenceRank = document.getElementById('preference-rank');
        const preferenceSchool = document.getElementById('preference-school');
        const preferenceDepartment = document.getElementById('preference-department');
        const preferenceModalClose = document.getElementById('preference-modal-close');
        const preferenceModalCancel = document.getElementById('preference-modal-cancel');
        const preferenceModalSave = document.getElementById('preference-modal-save');
        
        // 個人資料表單欄位
        const profileName = document.getElementById('profile-name');
        const profileSchool = document.getElementById('profile-school');
        const profileGrade = document.getElementById('profile-grade');
        const profileClass = document.getElementById('profile-class');
        const profileEmail = document.getElementById('profile-email');
        const profilePhone = document.getElementById('profile-phone');
        //const studentNameTitle = document.getElementById('student-name');
        
        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded");
        
        // Initialize Firebase config
        const firebaseConfig = {
            apiKey: "{{ firebase_config.apiKey if firebase_config is defined else '' }}",
            authDomain: "{{ firebase_config.authDomain if firebase_config is defined else '' }}",
            projectId: "{{ firebase_config.projectId if firebase_config is defined else '' }}",
            storageBucket: "{{ firebase_config.storageBucket if firebase_config is defined else '' }}",
            messagingSenderId: "{{ firebase_config.messagingSenderId if firebase_config is defined else '' }}",
            appId: "{{ firebase_config.appId if firebase_config is defined else '' }}"
        };
        console.log("Firebase config:", firebaseConfig);
        console.log("Student ID:", STUDENT_ID);
        
        // Try to initialize Firebase
        try {
            if (firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("Firebase initialized successfully");
                
                // Set up event listeners
                setupEventListeners();
                
                // Load data
                loadStudentData();
                loadPreferredDepartments();
            } else {
                throw new Error("Firebase config is missing API key");
            }
        } catch (error) {
            console.error("Firebase initialization error:", error);
            //showNotification('error', '無法連接到 Firebase，請重新整理頁面或聯絡系統管理員。');
        }
    });
        
        /**
         * 設置所有事件監聽器
         */
        function setupEventListeners() {
            // 個人資料編輯模式切換
            togglePersonalEditBtn.addEventListener('click', togglePersonalInfoEditMode);
            
            // 個人資料表單提交
            personalInfoForm.addEventListener('submit', savePersonalInfo);
            
            // 新增志願按鈕
            addPreferenceBtn.addEventListener('click', openAddPreferenceModal);
            
            // 關閉志願模態框
            preferenceModalClose.addEventListener('click', closePreferenceModal);
            preferenceModalCancel.addEventListener('click', closePreferenceModal);
            
            // 儲存志願
            preferenceModalSave.addEventListener('click', savePreference);
            
            // 登出按鈕
            document.getElementById('logout-btn').addEventListener('click', function() {
                // 實際整合時，這裡應處理登出功能
                alert('登出功能尚未實作');
            });
        }
        
        // Add these global variables
        let studentDataLoaded = false;
        let preferencesLoaded = false;

        // Then modify the loadStudentData function
        async function loadStudentData() {
            try {
                const docRef = db.collection('users').doc(STUDENT_ID);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    studentData = doc.data() || {};
                    
                    // Fill form fields with fallbacks for missing data
                    profileName.value = studentData.name || '';
                    profileSchool.value = studentData.school || '';
                    profileGrade.value = studentData.grade || '';
                    profileClass.value = studentData.class || '';
                    profileEmail.value = studentData.email || '';
                    profilePhone.value = studentData.phone || '';

                    // Mark student data as loaded
                    studentDataLoaded = true;
                    
                    // Update header if both data sources are loaded
                    if (preferencesLoaded) {
                        updateProfileHeader();
                    }
                } else {
                    // Document doesn't exist - create empty profile
                    showNotification('info', 'Creating new student profile...');
                    
                    // Initialize empty studentData
                    studentData = {
                        name: '',
                        school: '',
                        grade: '',
                        class: '',
                        email: '',
                        phone: ''
                    };
                    
                    studentDataLoaded = true;
                    if (preferencesLoaded) {
                        updateProfileHeader();
                    }
                }
            } catch (error) {
                console.error('Error getting student data:', error);
                showNotification('error', `Failed to load profile: ${error.message}`);
            }
        }

        // Modify the loadPreferredDepartments function
        async function loadPreferredDepartments() {
            try {
                preferencesContainer.innerHTML = `
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <span>載入中...</span>
                    </div>
                `;
                
                const docRef = db.collection('users').doc(STUDENT_ID);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    const data = doc.data() || {};
                    if (data.preferred_departments && Array.isArray(data.preferred_departments)) {
                        preferredDepartments = data.preferred_departments;
                        // Sort by rank
                        preferredDepartments.sort((a, b) => a.rank - b.rank);
                    } else {
                        // Initialize empty array if preferred_departments doesn't exist
                        preferredDepartments = [];
                    }
                    
                    // Render the departments (even if empty)
                    renderPreferredDepartments();
                    
                    // Mark preferences as loaded
                    preferencesLoaded = true;
                    
                    // Update header if both data sources are loaded
                    if (studentDataLoaded) {
                        updateProfileHeader();
                    }
                } else {
                    preferredDepartments = [];
                    renderPreferredDepartments();
                    
                    preferencesLoaded = true;
                    if (studentDataLoaded) {
                        updateProfileHeader();
                    }
                }
            } catch (error) {
                console.error('獲取志願序錯誤:', error);
                preferencesContainer.innerHTML = `
                    <div class="notification error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>載入志願序失敗: ${error.message}</span>
                    </div>
                `;
            }
        }
        
        function renderPreferredDepartments() {
            if (!preferredDepartments || preferredDepartments.length === 0) {
                preferencesContainer.innerHTML = `
                    <div class="notification info">
                        <i class="fas fa-info-circle"></i>
                        <span>您尚未設定任何志願科系。</span>
                    </div>
                `;
                return;
            }
            
            let html = '<ul class="preference-list" id="sortable-preferences">';
            
            preferredDepartments.forEach((pref, index) => {
                html += `
                    <li class="preference-item" draggable="true" data-index="${index}">
                        <div class="drag-handle">
                            <i class="fas fa-grip-lines"></i>
                        </div>
                        <div class="preference-rank">${pref.rank}</div>
                        <div class="preference-content">
                            <div class="preference-school">${pref.school}</div>
                            <div class="preference-department">${pref.department}</div>
                        </div>
                        <div class="preference-actions">
                            <button type="button" class="preference-action-btn edit" data-index="${index}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="preference-action-btn delete" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </li>
                `;
            });
            
            html += '</ul>';
            preferencesContainer.innerHTML = html;
            
            // Add drag and drop event listeners
            const preferenceItems = document.querySelectorAll('.preference-item');
            preferenceItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragenter', handleDragEnter);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
            });
            
            // Add edit and delete button event listeners
            document.querySelectorAll('.preference-action-btn.edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    openEditPreferenceModal(index);
                });
            });
            
            document.querySelectorAll('.preference-action-btn.delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    deletePreference(index);
                });
            });
        }

        // Drag and drop variables
        let draggedItem = null;
        let dragSourceIndex = null;

        function handleDragStart(e) {
            draggedItem = this;
            dragSourceIndex = parseInt(this.getAttribute('data-index'));
            
            // Set the drag effect
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            
            // Add dragging class for styling
            setTimeout(() => {
                this.classList.add('dragging');
            }, 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            // Remove drag-over class from all items
            document.querySelectorAll('.preference-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault(); // Necessary to allow dropping
            }
            
            e.dataTransfer.dropEffect = 'move';
            
            return false;
        }

        function handleDragEnter(e) {
            this.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            // Prevent default action
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            // Only process if we're not dropping onto the original element
            if (draggedItem !== this) {
                const dropTargetIndex = parseInt(this.getAttribute('data-index'));
                
                // Rearrange the preferredDepartments array
                const temp = [...preferredDepartments];
                const draggedItemData = temp[dragSourceIndex];
                
                // Remove from original position
                temp.splice(dragSourceIndex, 1);
                
                // Insert at new position
                temp.splice(dropTargetIndex, 0, draggedItemData);
                
                // Update the ranks based on new order
                temp.forEach((item, idx) => {
                    item.rank = idx + 1;
                });
                
                // Save the reordered departments
                preferredDepartments = temp;
                saveReorderedPreferences();
            }
            
            return false;
        }

        // Function to save the reordered preferences to Firebase
        async function saveReorderedPreferences() {
            // Sort by rank for safety
            preferredDepartments.sort((a, b) => a.rank - b.rank);
            
            // Show loading notification
            showNotification('info', '<div class="loading-spinner" style="margin-right: 10px;"></div> 正在更新志願序...');
            
            try {
                // Update Firestore
                await db.collection('users').doc(STUDENT_ID).update({
                    preferred_departments: preferredDepartments
                });
                
                // Show success notification
                showNotification('success', '<i class="fas fa-check-circle"></i> 志願序已成功更新！');
                
                // Refresh the view
                renderPreferredDepartments();
                
                // Update the header
                updateProfileHeader();
            } catch (error) {
                console.error('更新志願序錯誤:', error);
                showNotification('error', `<i class="fas fa-exclamation-triangle"></i> 更新失敗: ${error.message}`);
                
                // Reload the preferences in case of error
                loadPreferredDepartments();
            }
        }
        
        /**
         * Update the profile header with student information
         */
        function updateProfileHeader() {
            // Set initial values
            document.getElementById('header-name').textContent = studentData.name || '未設定姓名';
            document.getElementById('header-school-info').textContent = studentData.school || '未設定學校';
            document.getElementById('header-grade-info').textContent = studentData.grade ? `年級: ${studentData.grade}` : '未設定年級';
            document.getElementById('header-class-info').textContent = studentData.class ? `班級: ${studentData.class}` : '未設定班級';
            //document.getElementById('header-target-departments').textContent = studentData.department ? `目標科系: ${studentData.department}` : '未設定科系';

            // Update profile picture with initials
            const profilePicture = document.getElementById('profile-picture');
            if (studentData.name) {
                const initials = studentData.name.charAt(0);
                profilePicture.textContent = initials;
            } else {
                profilePicture.textContent = '?';
            }
            
            // Update target departments - change to show as a single line summary
            const headerTargetDepartments = document.getElementById('header-target-departments');
            if (preferredDepartments && preferredDepartments.length > 0) {
                // Sort by rank
                const sortedDepartments = [...preferredDepartments].sort((a, b) => a.rank - b.rank);
                
                // Just extract department names (without ranks or colors) for the summary line
                const departmentNames = sortedDepartments.map(dept => dept.department);
                
                // Join with slashes
                headerTargetDepartments.textContent = `目標科系：${departmentNames.join(' / ')}`;
            } else {
                headerTargetDepartments.textContent = '目標科系：尚未設定';
            }
        }

        /**
         * Get color for department rank
         */
        function getDepartmentColor(rank) {
            const colors = [
                '#4e54c8', // 第 1 志願 - 深藍紫色
                '#5d8a9e', // 第 2 志願 - 藍綠色
                '#3cb371', // 第 3 志願 - 中等海綠色
                '#f9a825', // 第 4 志願 - 琥珀黃色
                '#e57373', // 第 5 志願 - 淡紅色
                '#9575cd'  // 第 6 志願 - 淡紫色
            ];
            
            return colors[rank - 1] || '#8d939e';
        }

        function togglePersonalInfoEditMode() {
            const formControls = personalInfoForm.querySelectorAll('.form-control');
            const isDisabled = formControls[0].disabled;
            
            // 切換所有欄位的禁用狀態
            formControls.forEach(control => {
                control.disabled = !isDisabled;
            });
            
            // 切換儲存按鈕的禁用狀態
            savePersonalInfoBtn.disabled = !isDisabled;
            
            // 更新編輯按鈕的文字和樣式
            if (isDisabled) {
                togglePersonalEditBtn.innerHTML = '<i class="fas fa-times"></i> 取消';
                togglePersonalEditBtn.classList.add('active');
            } else {
                togglePersonalEditBtn.innerHTML = '<i class="fas fa-pen"></i> 編輯';
                togglePersonalEditBtn.classList.remove('active');
                
                // 如果取消編輯，重新載入原始資料
                profileName.value = studentData.name || '';
                profileSchool.value = studentData.school || '';
                profileGrade.value = studentData.grade || '';
                profileClass.value = studentData.class || '';
                profileEmail.value = studentData.email || '';
                profilePhone.value = studentData.phone || '';
            }
        }

        async function savePersonalInfo(event) {
            event.preventDefault();
            
            // 獲取表單資料
            const updatedData = {
                name: profileName.value.trim(),
                school: profileSchool.value.trim(),
                grade: profileGrade.value.trim(),
                class: profileClass.value.trim(),
                email: profileEmail.value.trim(),
                phone: profilePhone.value.trim(),
                updatedAt: new Date()
            };
            
            // 顯示儲存中通知
            showNotification('info', '<div class="loading-spinner" style="margin-right: 10px;"></div> 正在儲存資料...');
            
            try {
                // 更新 Firestore 文檔
                await db.collection('users').doc(STUDENT_ID).set(updatedData, { merge: true });
                
                // 更新本地資料
                studentData = { ...studentData, ...updatedData };
                
                // 更新頁面標題
                profileName.textContent = studentData.name || '學生資料';
                
                // 立即更新 header
                updateProfileHeader();
                
                // 顯示成功通知
                showNotification('success', '<i class="fas fa-check-circle"></i> 個人資料已成功更新！');
                
                // 關閉編輯模式
                togglePersonalInfoEditMode();
            } catch (error) {
                console.error('儲存個人資料錯誤:', error);
                showNotification('error', `<i class="fas fa-exclamation-triangle"></i> 儲存失敗: ${error.message}`);
            }
        }
        
        /**
         * 開啟新增志願模態框
         */
        function openAddPreferenceModal() {
            // 檢查是否已有 6 個志願
            if (preferredDepartments.length >= 6) {
                showNotification('warning', '<i class="fas fa-exclamation-circle"></i> 最多只能設定 6 個志願');
                return;
            }
            
            // 重置表單
            preferenceForm.reset();
            preferenceEditIndex.value = -1;
            preferenceModalTitle.textContent = '新增志願';
            
            // 設定預設的志願序（取得目前未使用的最小序號）
            const usedRanks = preferredDepartments.map(p => p.rank);
            for (let i = 1; i <= 6; i++) {
                if (!usedRanks.includes(i)) {
                    preferenceRank.value = i;
                    break;
                }
            }
            
            // 顯示模態框
            preferenceModal.style.display = 'flex';
        }
        
        /**
         * 開啟編輯志願模態框
         */
        function openEditPreferenceModal(index) {
            const preference = preferredDepartments[index];
            
            // 設定表單值
            preferenceEditIndex.value = index;
            preferenceRank.value = preference.rank;
            preferenceSchool.value = preference.school;
            preferenceDepartment.value = preference.department;
            
            // 更新模態框標題
            preferenceModalTitle.textContent = '編輯志願';
            
            // 顯示模態框
            preferenceModal.style.display = 'flex';
        }
        
        /**
         * 關閉志願模態框
         */
        function closePreferenceModal() {
            preferenceModal.style.display = 'none';
        }
        
        /**
         * 儲存志願到 Firestore
         */
        async function savePreference() {
            // 獲取表單數據
            const rank = parseInt(preferenceRank.value);
            const school = preferenceSchool.value.trim();
            const department = preferenceDepartment.value.trim();
            
            // 驗證資料
            if (!school || !department) {
                showNotification('warning', '<i class="fas fa-exclamation-circle"></i> 請填寫所有必填欄位');
                return;
            }
            
            // 檢查是否編輯現有志願或新增志願
            const editIndex = parseInt(preferenceEditIndex.value);
            let updatedPreferences = [...preferredDepartments];
            
            // 檢查是否有重複的 rank
            const hasDuplicateRank = editIndex === -1 ? 
                updatedPreferences.some(p => p.rank === rank) :
                updatedPreferences.some((p, idx) => idx !== editIndex && p.rank === rank);
            
            if (hasDuplicateRank) {
                // 如果有重複的 rank，將後續的 rank 值加 1
                updatedPreferences = updatedPreferences.map(p => {
                    if (p.rank >= rank && (editIndex === -1 || preferredDepartments[editIndex].rank !== p.rank)) {
                        return { ...p, rank: p.rank + 1 };
                    }
                    return p;
                });
            }
            
            if (editIndex === -1) {
                // 新增志願
                updatedPreferences.push({
                    rank,
                    school,
                    department,
                    createdAt: new Date()
                });
            } else {
                // 編輯現有志願
                updatedPreferences[editIndex] = {
                    ...updatedPreferences[editIndex],
                    rank,
                    school,
                    department,
                    updatedAt: new Date()
                };
            }
            
            // 根據 rank 排序
            updatedPreferences.sort((a, b) => a.rank - b.rank);
            
            // 顯示儲存中通知
            showNotification('info', '<div class="loading-spinner" style="margin-right: 10px;"></div> 正在儲存志願...');
            
            try {
                // 更新 Firestore
                await db.collection('users').doc(STUDENT_ID).update({
                    preferred_departments: updatedPreferences
                });
                
                // 更新本地資料
                preferredDepartments = updatedPreferences;
                
                // 顯示成功通知
                showNotification('success', '<i class="fas fa-check-circle"></i> 志願已成功儲存！');
                
                updateProfileHeader();

                // 重新渲染志願列表
                renderPreferredDepartments();
                
                // 關閉模態框
                closePreferenceModal();
            } catch (error) {
                console.error('儲存志願錯誤:', error);
                showNotification('error', `<i class="fas fa-exclamation-triangle"></i> 儲存失敗: ${error.message}`);
            }
        }
        
        /**
         * 刪除志願
         */
        async function deletePreference(index) {
            if (!confirm('確定要刪除此志願？')) {
                return;
            }
            
            // 刪除志願並更新排序
            const updatedPreferences = [...preferredDepartments];
            updatedPreferences.splice(index, 1);
            
            // 顯示刪除中通知
            showNotification('info', '<div class="loading-spinner" style="margin-right: 10px;"></div> 正在刪除志願...');
            
            try {
                // 更新 Firestore
                await db.collection('users').doc(STUDENT_ID).update({
                    preferred_departments: updatedPreferences
                });
                
                // 更新本地資料
                preferredDepartments = updatedPreferences;
                
                updateProfileHeader();

                // 顯示成功通知
                showNotification('success', '<i class="fas fa-check-circle"></i> 志願已成功刪除！');
                
                // 重新渲染志願列表
                renderPreferredDepartments();
            } catch (error) {
                console.error('刪除志願錯誤:', error);
                showNotification('error', `<i class="fas fa-exclamation-triangle"></i> 刪除失敗: ${error.message}`);
            }
        }
        
        /**
         * 顯示通知訊息
         */
        function showNotification(type, message) {
            const notificationArea = document.getElementById('notification-area');
            
            // 創建通知元素
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = message;
            
            // 清除現有通知
            notificationArea.innerHTML = '';
            
            // 添加新通知
            notificationArea.appendChild(notification);
            
            // 設定自動消失定時器（除非是載入中通知）
            if (!message.includes('loading-spinner')) {
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.5s';
                    
                    setTimeout(() => {
                        if (notification.parentNode === notificationArea) {
                            notificationArea.removeChild(notification);
                        }
                    }, 500);
                }, 5000);
            }
        }
    </script>
</body>
</html>